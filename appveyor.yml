# Visual Studio 2019 image is missing a preinstalled MySQL
image: Visual Studio 2017
clone_depth: 1

services:
  - mysql

environment:
  global:
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

install:
  # The following can be used to install a custom version of .NET Core
  - ps: Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dotnet/cli/master/scripts/obtain/dotnet-install.ps1" -OutFile "install-dotnet.ps1"
  - ps: ./install-dotnet.ps1 -Version 3.0.100-rc1-014190

before_build:
  - appveyor-retry dotnet restore -v Minimal

build_script:
  - ps: cp test\EFCore.MySql.FunctionalTests\config.json.example test\EFCore.MySql.FunctionalTests\config.json
  - ps: cp test\EFCore.MySql.IntegrationTests\appsettings.ci.json test\EFCore.MySql.IntegrationTests\appsettings.json
  - ps: cp test\EFCore.MySql.IntegrationTests\config.json.example test\EFCore.MySql.IntegrationTests\config.json

test_script:
  # AppVeyor's MySQL server does not have the correct settings, and will not work with all Functional Tests
  # Run with SkipTests=true until a solution is found
  - ps: echo "Tests"; dotnet test -c Release test\EFCore.MySql.Tests
  - ps: echo "Functional Migration Tests"; dotnet test -c Release test\EFCore.MySql.FunctionalTests
  - ps: echo "Integration Tests applying migrations"; dotnet run --project test\EFCore.MySql.IntegrationTests\EFCore.MySql.IntegrationTests.csproj -c Release testMigrate
  - ps: echo "Integration Tests with EF_BATCH_SIZE=1"; dotnet test test\EFCore.MySql.IntegrationTests\EFCore.MySql.IntegrationTests.csproj -c Release
  - ps: echo "Integration Tests with EF_BATCH_SIZE=10"; $env:EF_BATCH_SIZE="10"; dotnet test test\EFCore.MySql.IntegrationTests\EFCore.MySql.IntegrationTests.csproj -c Release
  - ps: echo "Integration Tests with EF_RETRY_ON_FAILURE=3"; $env:EF_RETRY_ON_FAILURE="3"; dotnet test test\EFCore.MySql.IntegrationTests\EFCore.MySql.IntegrationTests.csproj -c Release
  - ps: echo "Integration Tests Building migrations with EF_DATABASE=pomelo_test2"; $env:EF_SCHEMA="pomelo_test2"; dotnet build .\test\EFCore.MySql.IntegrationTests\EFCore.MySql.IntegrationTests.csproj -c Release
  - ps: echo "Integration Tests with EF_SCHEMA=pomelo_test2"; $env:EF_SCHEMA="pomelo_test2"; dotnet test test\EFCore.MySql.IntegrationTests\EFCore.MySql.IntegrationTests.csproj -c Release 

deploy: off
